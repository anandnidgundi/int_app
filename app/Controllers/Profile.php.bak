<?php

namespace App\Controllers;

use App\Controllers\BaseController;
use CodeIgniter\API\ResponseTrait;
use App\Models\UserModel;
use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use Firebase\JWT\ExpiredException;

header("Access-Control-Allow-Methods: POST,GET, OPTIONS");

header('Access-Control-Allow-Credentials: true'); 
header("Access-Control-Allow-Methods: GET, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Content-Length, Accept-Encoding");
if ( "OPTIONS" === $_SERVER['REQUEST_METHOD'] ) {
    die();
}
class Profile extends BaseController
{
    use ResponseTrait;

    public function index()
    {
		
        log_message('info', 'Profile API called');

        // Get the Authorization header
        $authorizationHeader = $_SERVER['HTTP_AUTHORIZATION'];
		
        log_message('info', 'Authorization header: ' . $authorizationHeader);

        if (!$authorizationHeader) {
            log_message('error', 'Authorization header missing');
            return $this->respond(['error' => 'Authorization header required'], 401);
        }

        // Extract the token
        if (strpos($authorizationHeader, 'Bearer ') === 0) {
            $token = substr($authorizationHeader, 7); // Remove 'Bearer ' prefix
            log_message('info', 'Token extracted successfully');
        } else {
            log_message('error', 'Invalid Authorization header format');
            return $this->respond(['error' => 'Invalid Authorization header format'], 401);
        }

        try {
            $key = getenv('JWT_SECRET'); // Ensure your JWT_SECRET is set
            if (!$key) {
                log_message('error', 'JWT_SECRET not configured');
                return $this->respond(['error' => 'JWT_SECRET not configured'], 500);
            }

            // Decode the JWT token
            $decoded = JWT::decode($token, new Key($key, 'HS256'));
            log_message('info', 'Token decoded successfully');

            // Get user details from the database
            $userModel = new UserModel();
            $user = $userModel->where('emp_code', $decoded->emp_code)->first();

            if (!$user) {
                log_message('error', 'User not found: ' . $decoded->emp_code);
                return $this->respond(['error' => 'User not found'], 404);
            }

            // Return the user profile details (omit sensitive information)
            unset($user['password']); // Remove password if present
            log_message('info', 'User profile returned successfully');
            return $this->respond(['profile' => $user, 'status' => true], 200);

        } catch (ExpiredException $e) {
            log_message('error', 'Token has expired: ' . $e->getMessage());
            return $this->respond(['error' => 'Token has expired'], 401);
        } catch (\Exception $e) {
            log_message('error', 'Token decoding error: ' . $e->getMessage());
            return $this->respond(['error' => 'Invalid token: ' . $e->getMessage()], 401);
        }
    }
}
